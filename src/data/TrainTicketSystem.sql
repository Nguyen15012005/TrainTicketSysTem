USE [TrainTicketSystem]
GO

-- Bảng ChiTietHoaDon
CREATE TABLE ChiTietHoaDon(
    MaHD VARCHAR(15) NOT NULL,
    MaVe CHAR(14) NOT NULL,
    GiaVeSauGiam DECIMAL(15, 2) NOT NULL,
    PRIMARY KEY (MaHD, MaVe)
);

-- Bảng ChiTietLichTrinh
CREATE TABLE ChiTietLichTrinh(
    maChiTietLichTrinh VARCHAR(20) NOT NULL PRIMARY KEY,
    MaLichTrinh VARCHAR(15) NOT NULL,
    maGa VARCHAR(10) NOT NULL,
    thuTuGa INT NOT NULL,
    gioDi TIME NULL,
    gioDen TIME NULL
);

-- Bảng ChoNgoi
CREATE TABLE ChoNgoi(
    MaChoNgoi VARCHAR(15) NOT NULL PRIMARY KEY,
    Tang INT NOT NULL,
    Khoang INT NOT NULL,
    Toa VARCHAR(10) NOT NULL,
    SoGhe INT NOT NULL,
    LoaiChoNgoi NVARCHAR(50) NOT NULL
);

-- Bảng ChuyenTau
CREATE TABLE ChuyenTau(
    maChuyenTau VARCHAR(10) NOT NULL PRIMARY KEY,
    MaLoaiTau VARCHAR(10) NOT NULL,
    tenChuyenTau NVARCHAR(50) NOT NULL,
    trangThai BIT NOT NULL DEFAULT 1
);

-- Bảng Ga
CREATE TABLE Ga(
    MaGa VARCHAR(10) NOT NULL PRIMARY KEY,
    TenGa NVARCHAR(50) NOT NULL,
    trangThaiGa BIT NOT NULL DEFAULT 1
);

-- Bảng HoaDon
CREATE TABLE HoaDon(
    MaHD VARCHAR(15) NOT NULL PRIMARY KEY,
    MaNV VARCHAR(11) NOT NULL,
    MaKH VARCHAR(10) NOT NULL,
    NgayLapHoaDon DATE NOT NULL CHECK (NgayLapHoaDon <= GETDATE()),
    MaKM VARCHAR(15) NOT NULL,
    TongTien DECIMAL(15, 2) NOT NULL CHECK (TongTien >= 0),
    TongGiamGia DECIMAL(15, 2) NOT NULL CHECK (TongGiamGia >= 0),
    CONSTRAINT CHK_TongTien CHECK (TongTien >= TongGiamGia)
);

-- Bảng KhachHang
CREATE TABLE KhachHang(
    MaKH VARCHAR(10) NOT NULL PRIMARY KEY,
    TenKH NVARCHAR(50) NOT NULL CHECK (LEN(TenKH) <= 100),
    SoCCCD CHAR(12) NOT NULL UNIQUE CHECK (LEN(SoCCCD) BETWEEN 9 AND 12),
    SDT VARCHAR(11) NOT NULL UNIQUE CHECK (LEN(SDT) = 10 AND SDT LIKE '0[0-9]%'),
    Email VARCHAR(100) NULL CHECK (Email LIKE '%@%.%')
);

-- Bảng KhoangCachGa
CREATE TABLE KhoangCachGa(
    maGaDi VARCHAR(10) NOT NULL,
    maGaDen VARCHAR(10) NOT NULL,
    KhoangCach DECIMAL(10, 2) NOT NULL CHECK (KhoangCach >= 0),
    PRIMARY KEY (maGaDi, maGaDen)
);

-- Bảng KhuyenMai
CREATE TABLE KhuyenMai(
    MaKM VARCHAR(15) NOT NULL PRIMARY KEY,
    MoTa NVARCHAR(255),
    NgayApDung DATE,
    NgayHetHan DATE,
    MucKM FLOAT,
    trangThaiKM BIT,
    LoaiKM NVARCHAR(50)
);

-- Bảng LichTrinh
CREATE TABLE LichTrinh(
    MaLichTrinh NVARCHAR(20) NOT NULL PRIMARY KEY,
    MaChuyenTau NVARCHAR(20),
    GaDi NVARCHAR(50),
    GaDen NVARCHAR(50),
    ThoiGianKhoiHanh DATETIME,
    ThoiGianDuKienDen DATETIME,
    LoaiTau NVARCHAR(30) CHECK (LoaiTau IN ('TAU_CAO_CAP','TAU_NHANH','TAU_THONG_THUONG')),
    LoaiToa NVARCHAR(30),
    TrangThai BIT
);

-- Bảng LoaiTau
CREATE TABLE LoaiTau(
    MaLoaiTau VARCHAR(10) NOT NULL PRIMARY KEY,
    TenLoaiTau NVARCHAR(50) NOT NULL
);

-- Bảng LoaiToa
CREATE TABLE LoaiToa(
    MaLoaiToa VARCHAR(5) NOT NULL PRIMARY KEY,
    TenLoaiToa NVARCHAR(50) NOT NULL
);

-- Bảng LoaiVe
CREATE TABLE LoaiVe(
    MaLoaiVe VARCHAR(10) NOT NULL PRIMARY KEY,
    TenLoaiVe NVARCHAR(50) NOT NULL,
    MucGiamGia DECIMAL(3, 2) NOT NULL
);

-- Bảng NhanVien
CREATE TABLE NhanVien(
    maNhanVien VARCHAR(11) NOT NULL PRIMARY KEY,
    hoTen NVARCHAR(50) NOT NULL,
    ngaySinh DATE NOT NULL,
    NgayVaoLam DATE NOT NULL,
    SoCCCD VARCHAR(12) NOT NULL UNIQUE,
    GioiTinh BIT NOT NULL DEFAULT 0,
    SoDienThoai VARCHAR(15) NULL UNIQUE,
    Email VARCHAR(100) NULL UNIQUE,
    ChucVu NVARCHAR(50) NOT NULL DEFAULT 'NhanVienBanVe',
    TrangThai NVARCHAR(20) NOT NULL DEFAULT 'DangLam'
);

-- Bảng TaiKhoan
CREATE TABLE TaiKhoan(
    userID INT IDENTITY(1,1) PRIMARY KEY,
    userName NVARCHAR(100) NOT NULL,
    email NVARCHAR(100) NOT NULL UNIQUE,
    password NVARCHAR(100) NOT NULL,
    role NVARCHAR(50) NOT NULL,
    status BIT DEFAULT 1,
    createdDate DATE DEFAULT GETDATE()
);

-- Bảng Toa
CREATE TABLE Toa(
    MaToa VARCHAR(10) NOT NULL PRIMARY KEY,
    SoToa INT NOT NULL,
    LoaiToa VARCHAR(5) NOT NULL,
    SoLuongGhe INT NOT NULL,
    ChuyenTau VARCHAR(10) NOT NULL
);

-- Bảng Ve
CREATE TABLE Ve(
    MaVe CHAR(14) NOT NULL PRIMARY KEY,
    MaKH VARCHAR(10) NOT NULL,
    maLichTrinh VARCHAR(15) NOT NULL,
    MaLoaiVe VARCHAR(10) NOT NULL,
    maSoCho VARCHAR(15) NOT NULL,
    TenHanhKhach NVARCHAR(100) NOT NULL,
    SoCCCD CHAR(12) NOT NULL,
    NgaySinh DATE NOT NULL,
    TinhTrangVe NVARCHAR(20) NOT NULL DEFAULT N'Đã bán',
    KhuHoi BIT DEFAULT 0,
    GiaVe DECIMAL(12, 2) NOT NULL,
    GiaGiam DECIMAL(12, 2) NOT NULL
);
GO
